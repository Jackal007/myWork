<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "微软雅黑";
        }

        #allmap {
            height: 80%;
            width: 100%;
        }

        #r-result {
            height: 20%;
            width: 100%;
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=izf5TxNB1ML2uMnYIQlUDgPkw5VdW9Lx"></script>
    <title>map</title>
</head>
<body>
    <div style="height:80%;" id="allmap"></div>
    <div id="tmap"></div>
    <div id="r-result">
        <textarea id="input" rows="7" cols="100">
119.386703,25.71674 10
119.386703,25.72674 100
119.386703,25.73674 1000
119.386703,25.74674 2000
119.386703,25.75674 3000</textarea>
        <input type="button" onclick="generatePath();" value="查询">
    </div>
</body>
</html>
<script type="text/javascript">

    //declare some varibles
    var map = new BMap.Map("allmap");   //show things on this map
    var point = new BMap.Point(119.376414, 25.725794);      //the center point
    //config the map
    map.centerAndZoom(point, 15);
    map.enableScrollWheelZoom(true);
    map.enableDragging();
    //some global varibles
    var points = [];

    //carry out search on this map
    var searchMap = new BMap.Map("tmap");

    var MyPoint={
      createNew:function(num,p,a){
        point={};
        point.number=num;
        point.point=p;
        point.arrival=a;
        point.addLabel=function(content,offset){
          var opts = {
              position: point.point,    // link to the piont pont
              offset: new BMap.Size(0, offset)    //set the offset
          };
          var label = new BMap.Label(content, opts);  // define the label
          map.addOverlay(label);  //add the label to the map
        };
        point.mark=function(myIcon){
          //mark the point with myIcon
          var marker = new BMap.Marker(point.point, { icon: myIcon });
          map.addOverlay(marker);
        }
        /*add piont number*/
        point.addLabel(point.number,-20);
        return point;
      }
    };

    var MyRoute={
        createNew:function(start,end,useTime){
          route={};
          route.startPoint=start;
          route.endPoint=end;
          route.useTime=useTime;
          route.distance={};
          route.path={};
          route.velocity={};
          route.show=function(){
          //define a self-driving class
            var driving = new BMap.DrivingRoute(searchMap, {
              //set the hook function,will be called after search complete
              onSearchComplete: function (results) {
                  var plan=results.getPlan(0);
                  route.distance = plan.getDistance(false)*1.0;
                  route.path=plan.getRoute(0).getPath();
                }
              });
            route.velocity=(route.distance/route.useTime)/3.6;
              var color={};
              if (velocity < 5) {
                color='#f4ea29';
              }
              else if (velocity < 20&&velocity>5) {
                color='#FF4500';
              }
              else if(velocity>20){
                color='#d81e06';
              }
            map.addOverlay(new BMap.Polyline(route.path, {
                strokeColor: color,
                enableClicking: false
            }));
          }
          route.show();
          return route;
        }
      };

  function getData(){
        //get data from input
        var input = document.getElementById("input").value;
        var line = input.split('\n');
        for (var i = 0; i < line.length; i++) {
            var p = new BMap.Point(line[i].split(' ')[0].split(',')[0], line[i].split(' ')[0].split(',')[1]);
            var time = line[i].split(' ')[1];
            var t=MyPoint.createNew(p,time);
            points.push(t);
          }
      }

    function generatePath() {
        //get data
        getData();

        /* mark all the points */
        //mark the start point
        points[0].mark(new BMap.Icon("routers/start.png", new BMap.Size(64, 64)));
        //circle the points
        for (var i = 1; i < point.length-1; i++) {
          points[i].mark(new BMap.Icon("routers/circle.png", new BMap.Size(64, 64)));
        }
        //mark the end point
        points[points.length - 1].mark(new BMap.Icon("routers/end.png", new BMap.Size(64, 64)));

        /* create all routes */
        for (var i = 1; i < points.length; i++) {
            var r=MyRoute.createNew(points[i-1].p,points[i].p,points[i].arrival-points[i-1].arrival);
        }
    }
</script>
